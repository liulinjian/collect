<?php
class WeixinAction extends CommonAction {
	/*
		kaoder    采集器
		version   1.0
		author    littlebear
		date      2013/11/19
		func      根据文章来源url获取文章标题和内容 
	*/
	public $link = "http://weixin.sogou.com/weixin?type=1";
	public $page = 1;

	function __construct() {
		parent::__construct();
	}

	//解析URL主页 http://localhost/kd/?m=weixin
	public function index(){
		$this->display('Tpl/wx/index.html');
	}

	//获取openId
	public function openid(){
		$query = $_REQUEST["wxname"];
		$data = $_REQUEST["wxid"];
		$html = file_get_html( $link."&query=".$query."&page="$page);
		$results = $html->find('div.results a');
		$wxh = $html->find('div.txt-box h4');

		for ($i=0; $i < count($wxh); $i++) {

			$wxh[$i] = strip_tags($wxh[$i]);
			$wxh[$i] = substr($wxh[$i],13);
			$wxh[$i] = trim($wxh[$i]);

			if ($data == $wxh[$i]) {
				echo substr($results[$i]->getAttribute('href'),12);
			}else{
				$page += 1;
				openid($query, $data);
			}
		}
	}

	//获取articles
	//这里需要保存：微信号，容文章标题，内容简介，内容
	public function article(){
		$openid = trim( $_REQUEST['openid'] );
		if (!$openid) {
			echo "没有openid";
			exit();
		}

		$url = "http://weixin.sogou.com/gzhjs?cb=sogou.weixin.gzhcb&openid=".$openid;

		$json = file_get_html( $url );

		$json = preg_replace("/sogou.weixin.gzhcb\(/i","", $json);
		$json = preg_replace("/totalPages\"\:(\d{1,}).*/i","totalPages\":$1}", $json);
		
		$json = json_decode( $json );

		if ($json) {
			// page items(array) totalItems totalPages
			$str = $json->items[0];
			echo $str;
			exit();
			echo "<br><br><br>";
			$obj = simplexml_load_string($str, 'SimpleXMLElement', LIBXML_NOCDATA);
			echo $obj;
		}else{
			echo "没有找到文章记录";
		}
		//$json = json_decode( $json );
	}
	
}